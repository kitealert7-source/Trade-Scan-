# BROKER YAML USAGE AUDIT — CAPITAL WRAPPER (Phases 3–5)

## SECTION 1 — YAML FIELD INVENTORY

### Observed Fields Across 31 Broker YAMLs

| Field | Present In | Used by Wrapper | Status |\n| :--- | :--- | :--- | :--- |\n| `broker` | All | NO | Not loaded |\n| `reference_capital_usd` | All | NO | Not loaded |\n| `symbol` | All | NO (symbol comes from CSV) | Not loaded |\n| `min_lot` | All | NO (hardcoded in profile) | Loaded but unused |\n| `lot_step` | All | NO (hardcoded in profile) | Loaded but unused |\n| `max_lot` | All | NO | Not loaded |\n| `cost_model` | All | NO | Not loaded |\n| `apply_additional_costs` | All | NO | Not loaded |\n| `infer_missing_fields` | All | NO | Not loaded |\n| `allow_manual_override` | All | NO | Not loaded |\n| **`contract_size`** | All | **YES** | Used for notional calc |\n| `precision` | Some (JPY, cross) | NO | Not loaded |\n| `tick_size` | Some | NO | Not loaded |\n| `pip_size` | Some | NO | Not loaded |\n| `margin_currency` | Some (cross) | NO | Not loaded |\n| `profit_currency` | Some (cross) | NO | Not loaded |\n| `base_currency` | Some (cross) | NO | Not loaded |\n| `quote_currency` | Some (cross) | NO | Not loaded |\n| `notional_base_per_lot` | Some (cross) | NO | Not loaded |\n| **`calibration.base_lot`** | All | NO | Loaded but unused |\n| **`calibration.usd_pnl_per_price_unit_0p01`** | All | **YES** | Core sizing factor |\n| `calibration.price_unit` | All | NO | Not loaded |\n| `calibration.status` | All | NO | Not loaded |\n\n### Field Presence Inconsistency\n\n| Category | `precision` | `tick_size` | `pip_size` | `margin_currency` | `profit_currency` | `base_currency` | `quote_currency` |\n| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |\n| USD-quote (EURUSD, GBPUSD) | NO | NO | NO | NO | NO | NO | NO |\n| JPY pairs (USDJPY, EURJPY) | YES | YES | YES | YES | YES | NO | NO |\n| Cross (EURGBP) | YES | YES | YES | YES | YES | NO | NO |\n| Cross (AUDNZD, GBPAUD) | NO | NO | NO | NO | NO | YES | YES |\n| Index (NAS100) | NO | NO | NO | NO | NO | NO | NO |\n| Commodity (XAUUSD) | NO | NO | NO | NO | NO | NO | NO |\n\n> [!WARNING]\n> Non-uniform field presence across symbols. Schema is not standardized.\n\n---\n\n## SECTION 2 — CURRENT USAGE PATH\n\n### Code Trace\n\n```\nload_broker_spec(symbol) → yaml.safe_load()\n    ↓\nget_usd_per_price_unit(spec):\n    calibration.usd_pnl_per_price_unit_0p01 × 100 → usd_per_price_unit_per_lot\n    ↓\nrun_simulation():\n    symbol_usd_per_pu[sym] = get_usd_per_price_unit(spec)   ← SIZING + PNL\n    symbol_contract_size[sym] = spec[\"contract_size\"]         ← NOTIONAL\n    ↓\nprocess_entry():\n    risk_per_lot = risk_distance × usd_per_pu_per_lot         ← LOT SIZING\n    lot_size = (equity × risk_pct) / risk_per_lot\n    notional = lot_size × contract_size × entry_price          ← LEVERAGE CHECK\n    ↓\nprocess_exit():\n    pnl = price_delta × direction × usd_per_pu_per_lot × lot_size  ← PNL\n```\n\n### Fields Actually Used\n\n| Field | Code Reference | Purpose |\n| :--- | :--- | :--- |\n| `contract_size` | `float(spec[\"contract_size\"])` | Notional = lots × contract_size × price |\n| `calibration.usd_pnl_per_price_unit_0p01` | `get_usd_per_price_unit()` | USD per 1.0 price move per 1.0 lot |\n\nTotal fields used: **2 out of 22+**\n\n---\n\n## SECTION 3 — PRICE MOVEMENT AT ENTRY\n\n### Current Model: Fully YAML-Calibrated (Category A)\n\nThe wrapper uses `usd_pnl_per_price_unit_0p01` as a **static constant** per symbol. It does NOT recalculate pip value at entry time based on current price.\n\n| Aspect | Implementation |\n| :--- | :--- |\n| USD conversion at entry | NOT COMPUTED — uses static YAML constant |\n| Price-based pip recalculation | NONE |\n| Dynamic FX rate for cross pairs | NONE |\n| Calibration time vs trade time | DECOUPLED — calibration is fixed |\n\n### Impact by Pair Type\n\n| Pair Type | Static Calibration Accuracy | Risk |\n| :--- | :--- | :--- |\n| USD-quote (EURUSD, GBPUSD) | **Exact** — profit currency is USD, 1 pip always = $10/lot | NONE |\n| USD-base (USDCAD, USDCHF, USDJPY) | **Approximate** — profit in quote ccy, conversion rate drifts | LOW-MEDIUM |\n| Cross (EURGBP, EURJPY, AUDNZD) | **Approximate** — double conversion needed, both legs drift | MEDIUM |\n| Index (NAS100) | **Exact** — USD-denominated index points | NONE |\n| Commodity (XAUUSD) | **Exact** — USD-denominated | NONE |\n\n> [!IMPORTANT]\n> For a 19-year backtest, the USD conversion factor for non-USD-quote pairs drifts significantly. USDJPY moved from ~110 to ~155 over the dataset. The static calibration was likely taken at a single point in time, meaning lot sizing and PnL are distorted for the full historical range.\n\n---\n\n## SECTION 4 — INCONSISTENCY CHECK\n\n### Calibration Value Comparison\n\n| Symbol | `usd_pnl_per_price_unit_0p01` | `price_unit` | `status` | Notes |\n| :--- | :--- | :--- | :--- | :--- |\n| EURUSD | 1000.0 | USD | PASS | ✓ Correct: 0.01 lot × 100k × 1.0 = $1000 |\n| GBPUSD | 1000.0 | USD | PASS | ✓ Correct |\n| USDJPY | 6.33 | JPY | PASS | ~$633/lot, implies rate ~158 |\n| USDCAD | 7.25 | CAD | PASS | ~$725/lot, implies rate ~1.38 |\n| EURJPY | 6.33 | JPY | PASS | Same as USDJPY ✓ (same quote ccy) |\n| EURGBP | 1.25 | GBP | PASS | ~$125/lot, implies GBPUSD ~1.25 |\n| **AUDNZD** | **1666.14** | NZD | **DERIVED_BACKTEST_ONLY** | ⚠️ **ANOMALY** |\n| **GBPAUD** | **1436.31** | AUD | **DERIVED_BACKTEST_ONLY** | ⚠️ **ANOMALY** |\n| XAUUSD | 1.0 | USD | PASS | ✓ 0.01 lot × 100 oz × 1.0 = $1.00 |\n| NAS100 | 0.1 | INDEX_POINT | DERIVED_BACKTEST_ONLY | ✓ 0.01 lot × 10 × 1.0 = $0.10 |\n\n### Anomalies Flagged\n\n> [!CAUTION]\n> **AUDNZD: 1666.14** — Expected value for 0.01 lot (1000 NZD units) with NZDUSD ~0.60 is ~$600. A value of $1666 is ~2.8× too high.\n>\n> **GBPAUD: 1436.31** — Expected value for 0.01 lot (1000 AUD units) with AUDUSD ~0.65 is ~$650. A value of $1436 is ~2.2× too high.\n>\n> Both are tagged `DERIVED_BACKTEST_ONLY`, suggesting they were reverse-engineered from PnL data rather than computed from first principles. They may include contract_size baked in or use a different unit convention.\n\n### `calibration.status` Values\n\n| Status | Meaning | Symbols |\n| :--- | :--- | :--- |\n| `PASS` | Manually verified | EURUSD, GBPUSD, USDJPY, USDCAD, EURJPY, EURGBP, XAUUSD |\n| `DERIVED_BACKTEST_ONLY` | Reverse-engineered | AUDNZD, GBPAUD, NAS100 |\n\nWrapper does **not check `calibration.status`** — treats all values equally.\n\n---\n\n## SECTION 5 — RISK OF DISTORTION\n\n| Question | Answer |\n| :--- | :--- |\n| Could incorrect YAML calibration distort lot sizing? | **YES** — lot_size is directly proportional to 1/usd_pnl_per_price_unit. A 2× overstatement → 2× undersize → halved risk. |\n| Could incorrect contract_size distort leverage cap? | **YES** — notional = lots × contract_size × price. Wrong contract_size → false leverage ratio → incorrect rejection/acceptance. |\n| Is wrapper resilient to YAML errors? | **NO** — no validation of calibration values against expected ranges. No cross-check against contract_size. |\n| Should pip value be derived dynamically? | **YES for non-USD-quote pairs** — static calibration drifts significantly over 19 years. For USD-quote pairs, static is exact. |\n\n### Specific Distortion Risks\n\n| Risk | Severity | Affected Symbols |\n| :--- | :--- | :--- |\n| Static calibration drift over 19yr backtest | MEDIUM | All non-USD-quote (USDJPY, USDCAD, EURJPY, EURGBP, etc.) |\n| Anomalous `DERIVED_BACKTEST_ONLY` values | HIGH | AUDNZD, GBPAUD |\n| `min_lot`/`lot_step` from YAML ignored, hardcoded instead | LOW | All (profile overrides YAML — could diverge if YAML updated) |\n| `calibration.status` not validated | LOW | DERIVED symbols accepted without warning |\n\n---\n\n## VERDICT\n\n**MATERIAL RISK** for cross pairs (AUDNZD, GBPAUD) due to anomalous calibration values.\n\n**MINOR RISK** for USD-base pairs (USDJPY, USDCAD) due to static calibration drift over long horizons.\n\n**SAFE** for USD-quote pairs (EURUSD, GBPUSD) and USD-denominated instruments (XAUUSD, NAS100).\n", "Complexity": 1, "Description": "Complete broker YAML usage audit for the capital wrapper.", "EmptyFile": false, "IsArtifact": false, "Overwrite": false, "TargetFile": "c:\\Users\\faraw\\Documents\\Trade_Scan\\outputs\\reports\\BROKER_YAML_AUDIT.md"}
